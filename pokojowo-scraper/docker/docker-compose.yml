version: '3.8'

services:
  # Dashboard API
  scraper-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: pokojowo-scraper-api
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - POKOJOWO_API_URL=${POKOJOWO_API_URL:-http://pokojowo-api:3000}
      - POKOJOWO_EMAIL=${POKOJOWO_EMAIL}
      - POKOJOWO_PASSWORD=${POKOJOWO_PASSWORD}
      - SCRAPER_MONGODB_URL=mongodb://mongodb:27017
      - SCRAPER_DATABASE_NAME=pokojowo_scraper
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    command: ["serve", "--host", "0.0.0.0", "--port", "8001"]
    ports:
      - "8001:8001"
    depends_on:
      - mongodb
    networks:
      - pokojowo-network
    restart: unless-stopped

  scraper:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: pokojowo-scraper
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - POKOJOWO_API_URL=${POKOJOWO_API_URL:-http://pokojowo-api:3000}
      - POKOJOWO_EMAIL=${POKOJOWO_EMAIL}
      - POKOJOWO_PASSWORD=${POKOJOWO_PASSWORD}
      - SCRAPER_MONGODB_URL=mongodb://mongodb:27017
      - SCRAPER_DATABASE_NAME=pokojowo_scraper
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - mongodb
      - scraper-api
    networks:
      - pokojowo-network
    volumes:
      - scraper-data:/app/data
    restart: unless-stopped

  # Scheduled scraper (runs daily)
  scraper-scheduler:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: pokojowo-scraper-scheduler
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - POKOJOWO_API_URL=${POKOJOWO_API_URL:-http://pokojowo-api:3000}
      - POKOJOWO_EMAIL=${POKOJOWO_EMAIL}
      - POKOJOWO_PASSWORD=${POKOJOWO_PASSWORD}
      - SCRAPER_MONGODB_URL=mongodb://mongodb:27017
      - SCRAPER_DATABASE_NAME=pokojowo_scraper
      - SCHEDULE_ENABLED=true
      - SCHEDULE_CRON=0 6 * * *
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    command: ["schedule"]
    depends_on:
      - mongodb
    networks:
      - pokojowo-network
    restart: unless-stopped

  mongodb:
    image: mongo:7.0
    container_name: pokojowo-scraper-mongodb
    environment:
      - MONGO_INITDB_DATABASE=pokojowo_scraper
    volumes:
      - mongodb-data:/data/db
    networks:
      - pokojowo-network
    restart: unless-stopped

networks:
  pokojowo-network:
    external: true

volumes:
  scraper-data:
  mongodb-data:
